{% extends "base.html" %}

{% block title %}Survival Game{% endblock %}

{% block content %}
<style>
    .game-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
    }

    .game-header {
        margin-bottom: 20px;
        text-align: center;
    }

    .game-stats {
        display: flex;
        justify-content: space-between;
        width: 800px;
        margin-bottom: 20px;
        font-size: 18px;
    }

    .game-area {
        display: flex;
        gap: 20px;
    }

    #gameCanvas {
        background: #1a1a1a;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }

    .controls-panel {
        width: 250px;
        background: #2c2c2c;
        border-radius: 10px;
        padding: 15px;
        color: white;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }

    .controls-panel h3 {
        margin-top: 0;
        text-align: center;
        border-bottom: 1px solid #444;
        padding-bottom: 10px;
    }

    .status-bars {
        margin-bottom: 20px;
    }

    .status-bar {
        margin-bottom: 10px;
    }

    .status-bar-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }

    .status-bar-fill {
        height: 15px;
        border-radius: 3px;
        transition: width 0.3s;
    }

    .health-bar {
        background: #e74c3c;
    }

    .energy-bar {
        background: #f39c12;
    }

    .temperature-bar {
        background: #3498db;
    }

    .hunger-bar {
        background: #2ecc71;
    }

    .thirst-bar {
        background: #9b59b6;
    }

    .inventory {
        margin-top: 20px;
        border-top: 1px solid #444;
        padding-top: 10px;
    }

    .inventory-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 5px;
        margin-top: 10px;
    }

    .inventory-slot {
        width: 50px;
        height: 50px;
        background: #333;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .inventory-slot:hover {
        transform: scale(1.1);
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        z-index: 10;
    }

    .inventory-slot.selected {
        border: 2px solid #f39c12;
        box-shadow: 0 0 10px rgba(243, 156, 18, 0.7);
    }

    .inventory-slot img {
        max-width: 80%;
        max-height: 80%;
    }

    .inventory-slot .count {
        position: absolute;
        bottom: 2px;
        right: 2px;
        font-size: 10px;
        background: rgba(0, 0, 0, 0.7);
        padding: 1px 3px;
        border-radius: 3px;
    }
    
    .inventory-slot .tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
        white-space: nowrap;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
        z-index: 100;
        width: max-content;
        max-width: 200px;
        text-align: center;
    }
    
    .inventory-slot:hover .tooltip {
        opacity: 1;
    }
    
    .item-icon {
        font-size: 24px;
        text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
    }

    .game-buttons {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    button {
        padding: 10px;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        background: #4CAF50;
        color: white;
        cursor: pointer;
        transition: background 0.3s;
    }

    button:hover {
        background: #45a049;
    }

    .instructions {
        margin-top: 20px;
        max-width: 800px;
        text-align: center;
        line-height: 1.6;
    }

    .action-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 20px;
    }

    .action-button {
        background: #34495e;
    }

    .action-button:hover {
        background: #2c3e50;
    }

    .action-button:disabled {
        background: #555;
        cursor: not-allowed;
    }
</style>

<div class="game-container">
    <div class="game-header">
        <h1>Survival Game</h1>
        <div class="game-stats">
            <div>Day: <span id="dayValue">1</span></div>
            <div>Temperature: <span id="tempValue">20</span>¬∞C</div>
            <div>Time: <span id="timeValue">06:00</span></div>
        </div>
    </div>
    
    <div class="game-area">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div class="controls-panel">
            <h3>Status</h3>
            <div class="status-bars">
                <div class="status-bar">
                    <div class="status-bar-label">
                        <span>Health</span>
                        <span id="healthValue">100</span>
                    </div>
                    <div class="status-bar-fill health-bar" id="healthBar" style="width: 100%"></div>
                </div>
                <div class="status-bar">
                    <div class="status-bar-label">
                        <span>Energy</span>
                        <span id="energyValue">100</span>
                    </div>
                    <div class="status-bar-fill energy-bar" id="energyBar" style="width: 100%"></div>
                </div>
                <div class="status-bar">
                    <div class="status-bar-label">
                        <span>Temperature</span>
                        <span id="bodyTempValue">37</span>¬∞C
                    </div>
                    <div class="status-bar-fill temperature-bar" id="bodyTempBar" style="width: 50%"></div>
                </div>
                <div class="status-bar">
                    <div class="status-bar-label">
                        <span>Hunger</span>
                        <span id="hungerValue">100</span>
                    </div>
                    <div class="status-bar-fill hunger-bar" id="hungerBar" style="width: 100%"></div>
                </div>
                <div class="status-bar">
                    <div class="status-bar-label">
                        <span>Thirst</span>
                        <span id="thirstValue">100</span>
                    </div>
                    <div class="status-bar-fill thirst-bar" id="thirstBar" style="width: 100%"></div>
                </div>
            </div>
            
            <h3>Inventory</h3>
            <div class="inventory">
                <div class="inventory-grid" id="inventoryGrid">
                    <!-- Inventory slots will be added here -->
                </div>
            </div>
            
            <h3>Actions</h3>
            <div class="action-buttons">
                <button class="action-button" id="searchBtn">Search Area</button>
                <button class="action-button" id="restBtn">Rest</button>
                <button class="action-button" id="craftBtn">Craft</button>
                <button class="action-button" id="moveBtn">Move</button>
            </div>
            
            <div class="game-buttons">
                <button id="newGameBtn">New Game</button>
            </div>
        </div>
    </div>
    
    <div class="instructions">
        <p>Survive in the wilderness by managing your health, energy, temperature, hunger, and thirst.</p>
        <p>Search areas for resources, craft items, and move between locations to find shelter.</p>
        <p>Be careful of the weather and wildlife as they can be dangerous to your survival.</p>
    </div>
</div>

<script>
class SurvivalGame {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.tileSize = 40;
        this.player = {
            x: 10,
            y: 10,
            health: 100,
            energy: 100,
            bodyTemp: 37,
            hunger: 100,
            thirst: 100,
            inventory: [],
            selectedItem: null
        };
        this.world = {
            width: 20,
            height: 15,
            tiles: [],
            items: [],
            currentLocation: 'forest',
            day: 1,
            time: 6, // 6 AM
            temperature: 20,
            weather: 'clear'
        };
        this.locations = {
            forest: {
                name: 'Forest',
                description: 'A dense forest with trees and wildlife.',
                items: ['wood', 'berries', 'mushrooms', 'water_bottle', 'bandage'],
                danger: 0.2
            },
            lake: {
                name: 'Lake',
                description: 'A calm lake with fish and fresh water.',
                items: ['water_bottle', 'fish', 'rope', 'cloth'],
                danger: 0.1
            },
            mountain: {
                name: 'Mountain',
                description: 'A rocky mountain with caves and minerals.',
                items: ['stone', 'coal', 'rope', 'medkit'],
                danger: 0.3
            },
            cabin: {
                name: 'Cabin',
                description: 'An abandoned cabin with supplies.',
                items: ['canned_food', 'matches', 'blanket', 'medkit', 'axe'],
                danger: 0.05
            }
        };
        this.items = {
            wood: {
                name: 'Wood',
                description: 'Useful for crafting and fire.',
                icon: 'ü™µ',
                craftable: false
            },
            stone: {
                name: 'Stone',
                description: 'Useful for crafting tools.',
                icon: 'ü™®',
                craftable: false
            },
            berries: {
                name: 'Berries',
                description: 'Edible berries. Restores hunger.',
                icon: 'ü´ê',
                craftable: false,
                consumable: true,
                hungerRestore: 10
            },
            mushrooms: {
                name: 'Mushrooms',
                description: 'Edible mushrooms. Restores hunger.',
                icon: 'üçÑ',
                craftable: false,
                consumable: true,
                hungerRestore: 15
            },
            water_bottle: {
                name: 'Water Bottle',
                description: 'Contains fresh water. Restores thirst.',
                icon: 'ü•§',
                craftable: false,
                consumable: true,
                thirstRestore: 30
            },
            fish: {
                name: 'Fish',
                description: 'Fresh fish. Restores hunger significantly.',
                icon: 'üêü',
                craftable: false,
                consumable: true,
                hungerRestore: 25
            },
            rope: {
                name: 'Rope',
                description: 'Useful for crafting and climbing.',
                icon: 'üß∂',
                craftable: false
            },
            cloth: {
                name: 'Cloth',
                description: 'Useful for crafting clothing and bandages.',
                icon: 'üßµ',
                craftable: false
            },
            coal: {
                name: 'Coal',
                description: 'Useful for fire.',
                icon: 'ü™®',
                craftable: false
            },
            medkit: {
                name: 'Medkit',
                description: 'Restores health significantly.',
                icon: 'üíä',
                craftable: false,
                consumable: true,
                healthRestore: 50
            },
            canned_food: {
                name: 'Canned Food',
                description: 'Preserved food. Restores hunger significantly.',
                icon: 'ü•´',
                craftable: false,
                consumable: true,
                hungerRestore: 40
            },
            matches: {
                name: 'Matches',
                description: 'Used to start fires.',
                icon: 'üî•',
                craftable: false
            },
            blanket: {
                name: 'Blanket',
                description: 'Keeps you warm.',
                icon: 'üõèÔ∏è',
                craftable: false,
                equipable: true,
                warmthBonus: 5
            },
            axe: {
                name: 'Axe',
                description: 'Used to chop wood.',
                icon: 'ü™ì',
                craftable: false,
                equipable: true
            },
            bandage: {
                name: 'Bandage',
                description: 'Restores health.',
                icon: 'ü©π',
                craftable: false,
                consumable: true,
                healthRestore: 20
            },
            spear: {
                name: 'Spear',
                description: 'A simple weapon for hunting.',
                icon: 'üî±',
                craftable: true,
                requires: ['wood', 'stone'],
                equipable: true
            },
            fire: {
                name: 'Fire',
                description: 'Keeps you warm and cooks food.',
                icon: 'üî•',
                craftable: true,
                requires: ['wood', 'matches'],
                temporary: true,
                duration: 5,
                warmthBonus: 10
            }
        };
        
        // Add a game start delay to prevent immediate game over
        this.gameStartTime = Date.now();
        this.gameStarted = false;
        this.gracePeriod = true; // Add a grace period flag
        this.warningElement = null;
        this.lastWarning = null;
        
        this.initializeGame();
        this.setupEventListeners();
        this.gameLoop();
    }
    
    initializeGame() {
        // Generate world
        this.generateWorld();
        
        // Initialize inventory
        this.initializeInventory();
        
        // Update UI
        this.updateUI();
    }
    
    generateWorld() {
        // Generate tiles
        for (let y = 0; y < this.world.height; y++) {
            this.world.tiles[y] = [];
            for (let x = 0; x < this.world.width; x++) {
                // Simple terrain generation
                const distanceFromCenter = Math.sqrt(
                    Math.pow(x - this.world.width / 2, 2) + 
                    Math.pow(y - this.world.height / 2, 2)
                );
                
                if (distanceFromCenter < 3) {
                    this.world.tiles[y][x] = 'grass';
                } else if (distanceFromCenter < 5) {
                    this.world.tiles[y][x] = 'forest';
                } else {
                    this.world.tiles[y][x] = 'mountain';
                }
            }
        }
        
        // Place player in center
        this.player.x = Math.floor(this.world.width / 2);
        this.player.y = Math.floor(this.world.height / 2);
        
        // Generate items
        this.world.items = [];
        for (let i = 0; i < 20; i++) {
            const x = Math.floor(Math.random() * this.world.width);
            const y = Math.floor(Math.random() * this.world.height);
            
            // Get available items for current location
            const availableItems = this.locations[this.world.currentLocation].items;
            const itemType = availableItems[Math.floor(Math.random() * availableItems.length)];
            
            this.world.items.push({
                x: x,
                y: y,
                type: itemType
            });
        }
    }
    
    initializeInventory() {
        // Create inventory slots
        const inventoryGrid = document.getElementById('inventoryGrid');
        inventoryGrid.innerHTML = '';
        
        for (let i = 0; i < 12; i++) {
            const slot = document.createElement('div');
            slot.className = 'inventory-slot';
            slot.dataset.index = i;
            inventoryGrid.appendChild(slot);
        }
        
        // Add initial items
        this.addItemToInventory('water_bottle');
        this.addItemToInventory('bandage');
    }
    
    setupEventListeners() {
        // Canvas click for movement
        this.canvas.addEventListener('click', (e) => {
            const rect = this.canvas.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / this.tileSize);
            const y = Math.floor((e.clientY - rect.top) / this.tileSize);
            
            // Only move if the click is within the canvas bounds
            if (x >= 0 && x < this.world.width && y >= 0 && y < this.world.height) {
                this.movePlayer(x, y);
            }
        });
        
        // Add keyboard controls for movement
        document.addEventListener('keydown', (e) => {
            if (!this.gameStarted) return; // Don't allow movement before game starts
            
            let newX = this.player.x;
            let newY = this.player.y;
            
            switch(e.key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    newY = Math.max(0, this.player.y - 1);
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    newY = Math.min(this.world.height - 1, this.player.y + 1);
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    newX = Math.max(0, this.player.x - 1);
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    newX = Math.min(this.world.width - 1, this.player.x + 1);
                    break;
            }
            
            // Only move if the position changed
            if (newX !== this.player.x || newY !== this.player.y) {
                this.movePlayer(newX, newY);
            }
        });
        
        // Inventory selection
        const inventorySlots = document.querySelectorAll('.inventory-slot');
        inventorySlots.forEach(slot => {
            slot.addEventListener('click', () => {
                const index = parseInt(slot.dataset.index);
                this.selectInventoryItem(index);
            });
        });
        
        // Action buttons
        document.getElementById('searchBtn').addEventListener('click', () => {
            this.searchArea();
        });
        
        document.getElementById('restBtn').addEventListener('click', () => {
            this.rest();
        });
        
        document.getElementById('craftBtn').addEventListener('click', () => {
            this.showCraftingMenu();
        });
        
        document.getElementById('moveBtn').addEventListener('click', () => {
            this.showLocationMenu();
        });
        
        // New game button
        document.getElementById('newGameBtn').addEventListener('click', () => {
            this.resetGame();
        });
    }
    
    movePlayer(x, y) {
        // Check if within bounds
        if (x < 0 || y < 0 || x >= this.world.width || y >= this.world.height) {
            return;
        }
        
        // Check if adjacent to current position
        const dx = Math.abs(x - this.player.x);
        const dy = Math.abs(y - this.player.y);
        
        if (dx <= 1 && dy <= 1) {
            // Move player
            this.player.x = x;
            this.player.y = y;
            
            // Check for items
            this.checkForItems();
            
            // Consume energy
            this.player.energy = Math.max(0, this.player.energy - 5);
            
            // Update UI
            this.updateUI();
        }
    }
    
    checkForItems() {
        // Check if player is on an item
        const itemIndex = this.world.items.findIndex(item => 
            item.x === this.player.x && item.y === this.player.y
        );
        
        if (itemIndex !== -1) {
            // Add item to inventory
            this.addItemToInventory(this.world.items[itemIndex].type);
            
            // Remove item from world
            this.world.items.splice(itemIndex, 1);
            
            // Update UI
            this.updateUI();
        }
    }
    
    addItemToInventory(itemType) {
        // Check if item already exists in inventory
        const existingItem = this.player.inventory.find(item => item.type === itemType);
        
        if (existingItem) {
            existingItem.count++;
        } else {
            this.player.inventory.push({
                type: itemType,
                count: 1
            });
        }
        
        // Update inventory UI
        this.updateInventoryUI();
    }
    
    removeItemFromInventory(itemType) {
        // Find item in inventory
        const itemIndex = this.player.inventory.findIndex(item => item.type === itemType);
        
        if (itemIndex !== -1) {
            // Decrease count
            this.player.inventory[itemIndex].count--;
            
            // Remove if count is 0
            if (this.player.inventory[itemIndex].count <= 0) {
                this.player.inventory.splice(itemIndex, 1);
            }
            
            // Update inventory UI
            this.updateInventoryUI();
            
            return true;
        }
        
        return false;
    }
    
    selectInventoryItem(index) {
        // Check if item exists at index
        if (index < this.player.inventory.length) {
            // Deselect all slots
            document.querySelectorAll('.inventory-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
            
            // Select slot
            document.querySelector(`.inventory-slot[data-index="${index}"]`).classList.add('selected');
            
            // Set selected item
            this.player.selectedItem = this.player.inventory[index];
            
            // Check if item is consumable
            const item = this.items[this.player.selectedItem.type];
            if (item.consumable) {
                this.consumeItem(this.player.selectedItem.type);
            }
        } else {
            // Deselect all slots
            document.querySelectorAll('.inventory-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
            
            // Clear selected item
            this.player.selectedItem = null;
        }
    }
    
    consumeItem(itemType) {
        const item = this.items[itemType];
        
        // Apply effects
        if (item.healthRestore) {
            this.player.health = Math.min(100, this.player.health + item.healthRestore);
        }
        
        if (item.hungerRestore) {
            this.player.hunger = Math.min(100, this.player.hunger + item.hungerRestore);
        }
        
        if (item.thirstRestore) {
            this.player.thirst = Math.min(100, this.player.thirst + item.thirstRestore);
        }
        
        // Remove item from inventory
        this.removeItemFromInventory(itemType);
        
        // Update UI
        this.updateUI();
    }
    
    searchArea() {
        // Check if player has energy
        if (Math.ceil(this.player.energy) < 10) {
            alert('You are too tired to search.');
            return;
        }
        
        // Consume energy
        this.player.energy = Math.max(0, this.player.energy - 10);
        
        // Find items in current location
        const availableItems = this.locations[this.world.currentLocation].items;
        const foundItems = [];
        
        // Find 1-3 random items
        const numItems = Math.floor(Math.random() * 3) + 1;
        
        for (let i = 0; i < numItems; i++) {
            const itemType = availableItems[Math.floor(Math.random() * availableItems.length)];
            foundItems.push(itemType);
        }
        
        // Add items to inventory
        foundItems.forEach(itemType => {
            this.addItemToInventory(itemType);
        });
        
        // Show found items
        alert(`You found: ${foundItems.map(type => this.items[type].name).join(', ')}`);
        
        // Update UI
        this.updateUI();
    }
    
    rest() {
        // Check if player has energy
        if (Math.ceil(this.player.energy) >= 100) {
            alert('You are not tired.');
            return;
        }
        
        // Restore energy
        this.player.energy = Math.min(100, this.player.energy + 30);
        
        // Consume hunger and thirst (reduced consumption)
        this.player.hunger = Math.max(0, this.player.hunger - 5);
        this.player.thirst = Math.max(0, this.player.thirst - 7);
        
        // Advance time
        this.advanceTime(2);
        
        // Update UI
        this.updateUI();
    }
    
    showCraftingMenu() {
        // Get craftable items
        const craftableItems = Object.entries(this.items)
            .filter(([_, item]) => item.craftable)
            .map(([type, item]) => ({
                type,
                name: item.name,
                description: item.description,
                requires: item.requires
            }));
        
        if (craftableItems.length === 0) {
            alert('No craftable items available.');
            return;
        }
        
        // Create crafting menu
        let menu = 'Crafting Menu:\n\n';
        
        craftableItems.forEach((item, index) => {
            menu += `${index + 1}. ${item.name}: ${item.description}\n`;
            menu += `   Requires: ${item.requires.map(req => this.items[req].name).join(', ')}\n\n`;
        });
        
        menu += 'Enter the number of the item to craft (or 0 to cancel):';
        
        // Show menu
        const choice = prompt(menu);
        
        if (choice === null || choice === '0') {
            return;
        }
        
        const index = parseInt(choice) - 1;
        
        if (isNaN(index) || index < 0 || index >= craftableItems.length) {
            alert('Invalid choice.');
            return;
        }
        
        // Craft item
        this.craftItem(craftableItems[index].type);
    }
    
    craftItem(itemType) {
        const item = this.items[itemType];
        
        // Check if player has required items
        for (const requiredItem of item.requires) {
            if (!this.player.inventory.some(invItem => invItem.type === requiredItem)) {
                alert(`You need ${this.items[requiredItem].name} to craft ${item.name}.`);
                return;
            }
        }
        
        // Remove required items
        for (const requiredItem of item.requires) {
            this.removeItemFromInventory(requiredItem);
        }
        
        // Add crafted item
        this.addItemToInventory(itemType);
        
        // Show success message
        alert(`You crafted ${item.name}!`);
        
        // Update UI
        this.updateUI();
    }
    
    showLocationMenu() {
        // Get available locations
        const availableLocations = Object.keys(this.locations).filter(loc => loc !== this.world.currentLocation);
        
        if (availableLocations.length === 0) {
            alert('No other locations available.');
            return;
        }
        
        // Create location menu
        let menu = 'Available Locations:\n\n';
        
        availableLocations.forEach((location, index) => {
            const loc = this.locations[location];
            menu += `${index + 1}. ${loc.name}: ${loc.description}\n\n`;
        });
        
        menu += 'Enter the number of the location to move to (or 0 to cancel):';
        
        // Show menu
        const choice = prompt(menu);
        
        if (choice === null || choice === '0') {
            return;
        }
        
        const index = parseInt(choice) - 1;
        
        if (isNaN(index) || index < 0 || index >= availableLocations.length) {
            alert('Invalid choice.');
            return;
        }
        
        // Move to location
        this.moveToLocation(availableLocations[index]);
    }
    
    moveToLocation(location) {
        // Check if player has energy
        if (Math.ceil(this.player.energy) < 20) {
            alert('You are too tired to move.');
            return;
        }
        
        // Consume energy
        this.player.energy = Math.max(0, this.player.energy - 20);
        
        // Change location
        this.world.currentLocation = location;
        
        // Generate new world
        this.generateWorld();
        
        // Advance time
        this.advanceTime(3);
        
        // Show location description
        alert(`You moved to ${this.locations[location].name}.\n${this.locations[location].description}`);
        
        // Update UI
        this.updateUI();
    }
    
    advanceTime(hours) {
        // Advance time
        this.world.time += hours;
        
        // Check if day has passed
        if (this.world.time >= 24) {
            this.world.time -= 24;
            this.world.day++;
            
            // Randomize weather
            const weathers = ['clear', 'cloudy', 'rain', 'storm', 'snow'];
            this.world.weather = weathers[Math.floor(Math.random() * weathers.length)];
            
            // Update temperature based on weather
            if (this.world.weather === 'clear') {
                this.world.temperature = 20 + Math.floor(Math.random() * 10);
            } else if (this.world.weather === 'cloudy') {
                this.world.temperature = 15 + Math.floor(Math.random() * 10);
            } else if (this.world.weather === 'rain') {
                this.world.temperature = 10 + Math.floor(Math.random() * 10);
            } else if (this.world.weather === 'storm') {
                this.world.temperature = 5 + Math.floor(Math.random() * 10);
            } else if (this.world.weather === 'snow') {
                this.world.temperature = -10 + Math.floor(Math.random() * 10);
            }
        }
    }
    
    updateUI() {
        // Update stats
        document.getElementById('dayValue').textContent = this.world.day;
        document.getElementById('tempValue').textContent = this.world.temperature;
        document.getElementById('timeValue').textContent = `${String(Math.floor(this.world.time)).padStart(2, '0')}:00`;
        
        // Update status bars - round up all values to nearest whole number
        document.getElementById('healthValue').textContent = Math.ceil(this.player.health);
        document.getElementById('healthBar').style.width = `${Math.ceil(this.player.health)}%`;
        
        document.getElementById('energyValue').textContent = Math.ceil(this.player.energy);
        document.getElementById('energyBar').style.width = `${Math.ceil(this.player.energy)}%`;
        
        document.getElementById('bodyTempValue').textContent = Math.ceil(this.player.bodyTemp);
        document.getElementById('bodyTempBar').style.width = `${Math.ceil((this.player.bodyTemp - 35) * 10)}%`;
        
        document.getElementById('hungerValue').textContent = Math.ceil(this.player.hunger);
        document.getElementById('hungerBar').style.width = `${Math.ceil(this.player.hunger)}%`;
        
        document.getElementById('thirstValue').textContent = Math.ceil(this.player.thirst);
        document.getElementById('thirstBar').style.width = `${Math.ceil(this.player.thirst)}%`;
        
        // Update inventory
        this.updateInventoryUI();
    }
    
    updateInventoryUI() {
        // Clear inventory slots
        document.querySelectorAll('.inventory-slot').forEach(slot => {
            slot.innerHTML = '';
        });
        
        // Fill inventory slots
        this.player.inventory.forEach((item, index) => {
            const slot = document.querySelector(`.inventory-slot[data-index="${index}"]`);
            const itemData = this.items[item.type];
            
            // Create item icon with enhanced styling
            const iconDiv = document.createElement('div');
            iconDiv.className = 'item-icon';
            iconDiv.textContent = itemData.icon;
            
            // Create count indicator
            const countDiv = document.createElement('div');
            countDiv.className = 'count';
            countDiv.textContent = item.count;
            
            // Create tooltip with item description
            const tooltipDiv = document.createElement('div');
            tooltipDiv.className = 'tooltip';
            tooltipDiv.innerHTML = `<strong>${itemData.name}</strong><br>${itemData.description}`;
            
            // Add all elements to the slot
            slot.appendChild(iconDiv);
            slot.appendChild(countDiv);
            slot.appendChild(tooltipDiv);
        });
    }
    
    updateGame() {
        // Check if the game has started (after 5 seconds)
        if (!this.gameStarted && Date.now() - this.gameStartTime > 5000) {
            this.gameStarted = true;
        }
        
        // Only update survival mechanics after the game has started
        if (this.gameStarted) {
            // Grace period for 30 seconds after game starts
            if (this.gracePeriod && Date.now() - this.gameStartTime > 35000) {
                this.gracePeriod = false;
            }
            
            // Decrease hunger and thirst over time (much slower rate)
            this.player.hunger = Math.max(0, this.player.hunger - 0.01);
            this.player.thirst = Math.max(0, this.player.thirst - 0.02);
            
            // Update body temperature based on environment (less extreme)
            const tempDiff = this.world.temperature - this.player.bodyTemp;
            this.player.bodyTemp += tempDiff * 0.005;
            
            // Check for effects of hunger and thirst (only if not in grace period)
            if (!this.gracePeriod) {
                // Instead of decreasing health, just show warnings
                if (Math.ceil(this.player.hunger) <= 20) {
                    this.showWarning("You're getting hungry!");
                }
                
                if (Math.ceil(this.player.thirst) <= 20) {
                    this.showWarning("You're getting thirsty!");
                }
                
                // Check for effects of temperature (less extreme)
                if (Math.ceil(this.player.bodyTemp) < 35) {
                    this.showWarning("You're getting cold!");
                }
                
                if (Math.ceil(this.player.bodyTemp) > 40) {
                    this.showWarning("You're getting hot!");
                }
            }
        }
    }
    
    showWarning(message) {
        // Only show warning if we haven't shown it recently
        if (!this.lastWarning || Date.now() - this.lastWarning > 10000) {
            // Create warning element if it doesn't exist
            if (!this.warningElement) {
                this.warningElement = document.createElement('div');
                this.warningElement.style.position = 'absolute';
                this.warningElement.style.top = '70px';
                this.warningElement.style.left = '50%';
                this.warningElement.style.transform = 'translateX(-50%)';
                this.warningElement.style.backgroundColor = 'rgba(231, 76, 60, 0.8)';
                this.warningElement.style.color = 'white';
                this.warningElement.style.padding = '10px 20px';
                this.warningElement.style.borderRadius = '5px';
                this.warningElement.style.fontWeight = 'bold';
                this.warningElement.style.zIndex = '1000';
                this.warningElement.style.transition = 'opacity 0.5s';
                document.body.appendChild(this.warningElement);
            }
            
            // Show warning
            this.warningElement.textContent = message;
            this.warningElement.style.opacity = '1';
            
            // Hide warning after 3 seconds
            setTimeout(() => {
                if (this.warningElement) {
                    this.warningElement.style.opacity = '0';
                }
            }, 3000);
            
            // Update last warning time
            this.lastWarning = Date.now();
        }
    }
    
    draw() {
        // Clear canvas
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        // Draw tiles
        for (let y = 0; y < this.world.height; y++) {
            for (let x = 0; x < this.world.width; x++) {
                const tile = this.world.tiles[y][x];
                
                // Set tile color
                if (tile === 'grass') {
                    this.ctx.fillStyle = '#2ecc71';
                } else if (tile === 'forest') {
                    this.ctx.fillStyle = '#27ae60';
                } else if (tile === 'mountain') {
                    this.ctx.fillStyle = '#7f8c8d';
                }
                
                // Draw tile
                this.ctx.fillRect(
                    x * this.tileSize, 
                    y * this.tileSize, 
                    this.tileSize, 
                    this.tileSize
                );
                
                // Draw tile border
                this.ctx.strokeStyle = '#34495e';
                this.ctx.lineWidth = 0.5;
                this.ctx.strokeRect(
                    x * this.tileSize, 
                    y * this.tileSize, 
                    this.tileSize, 
                    this.tileSize
                );
            }
        }
        
        // Draw items with enhanced visuals
        this.world.items.forEach(item => {
            const itemData = this.items[item.type];
            const x = item.x * this.tileSize + this.tileSize / 2;
            const y = item.y * this.tileSize + this.tileSize / 2;
            
            // Draw item background glow
            this.ctx.shadowColor = 'rgba(255, 255, 255, 0.5)';
            this.ctx.shadowBlur = 10;
            
            // Draw item icon
            this.ctx.fillStyle = 'white';
            this.ctx.font = 'bold 24px Arial';
            this.ctx.textAlign = 'center';
            this.ctx.textBaseline = 'middle';
            this.ctx.fillText(itemData.icon, x, y);
            
            // Reset shadow
            this.ctx.shadowColor = 'transparent';
            this.ctx.shadowBlur = 0;
        });
        
        // Draw player
        this.ctx.fillStyle = '#e74c3c';
        this.ctx.beginPath();
        this.ctx.arc(
            this.player.x * this.tileSize + this.tileSize / 2,
            this.player.y * this.tileSize + this.tileSize / 2,
            this.tileSize / 3,
            0,
            Math.PI * 2
        );
        this.ctx.fill();
        
        // Draw location name
        this.ctx.fillStyle = 'white';
        this.ctx.font = '20px Arial';
        this.ctx.textAlign = 'center';
        this.ctx.fillText(
            this.locations[this.world.currentLocation].name,
            this.canvas.width / 2,
            30
        );
        
        // Draw weather
        let weatherIcon = '‚òÄÔ∏è';
        if (this.world.weather === 'cloudy') {
            weatherIcon = '‚òÅÔ∏è';
        } else if (this.world.weather === 'rain') {
            weatherIcon = 'üåßÔ∏è';
        } else if (this.world.weather === 'storm') {
            weatherIcon = '‚õàÔ∏è';
        } else if (this.world.weather === 'snow') {
            weatherIcon = '‚ùÑÔ∏è';
        }
        
        this.ctx.fillText(
            weatherIcon,
            this.canvas.width - 30,
            30
        );
        
        // Draw game start message if game hasn't started yet
        if (!this.gameStarted) {
            this.ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            
            this.ctx.fillStyle = 'white';
            this.ctx.font = 'bold 24px Arial';
            this.ctx.textAlign = 'center';
            this.ctx.fillText(
                'Game Starting...',
                this.canvas.width / 2,
                this.canvas.height / 2
            );
            
            this.ctx.font = '18px Arial';
            this.ctx.fillText(
                'Use WASD or arrow keys to move, click on items to collect them',
                this.canvas.width / 2,
                this.canvas.height / 2 + 30
            );
            
            this.ctx.fillText(
                'Use the action buttons to interact with the environment',
                this.canvas.width / 2,
                this.canvas.height / 2 + 60
            );
        } else if (this.gracePeriod) {
            // Draw grace period message
            this.ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            this.ctx.fillRect(0, 0, this.canvas.width, 60);
            
            this.ctx.fillStyle = 'white';
            this.ctx.font = 'bold 18px Arial';
            this.ctx.textAlign = 'center';
            this.ctx.fillText(
                'Grace Period: Your stats won\'t decrease for a while. Use this time to gather resources!',
                this.canvas.width / 2,
                30
            );
        }
    }
    
    gameLoop() {
        this.updateGame();
        this.draw();
        requestAnimationFrame(() => this.gameLoop());
    }
    
    resetGame() {
        // Reset player
        this.player = {
            x: 10,
            y: 10,
            health: 100,
            energy: 100,
            bodyTemp: 37,
            hunger: 100,
            thirst: 100,
            inventory: [],
            selectedItem: null
        };
        
        // Reset world
        this.world = {
            width: 20,
            height: 15,
            tiles: [],
            items: [],
            currentLocation: 'forest',
            day: 1,
            time: 6,
            temperature: 20,
            weather: 'clear'
        };
        
        // Reset game start time and grace period
        this.gameStartTime = Date.now();
        this.gameStarted = false;
        this.gracePeriod = true;
        
        // Reset warning system
        this.lastWarning = null;
        
        // Initialize game
        this.initializeGame();
    }
}

let game;

function newGame() {
    game = new SurvivalGame();
}

// Start the game when the page loads
window.onload = newGame;
</script>
{% endblock %} 