{% extends "base.html" %}

{% block title %}Gem Miner{% endblock %}

{% block content %}
   <!-- Back button to return to games list -->
<div class="custom-back-button-container">
    <a href="../games" class="custom-back-button">‚Üê Back to Games</a>
</div>

<article class="post">
    <header class="post-header">
        <h1 class="post-title">Gem Miner</h1>
        <hr />
    </header>

    <div class="post-content">
        <div class="game-description">
            <p>Dig deep into the mine to discover valuable gems! Mine gems, sell them for money, and upgrade your tools to dig deeper and find rarer gems.</p>
        </div>
        
        <div class="game-wrapper">
            <div class="game-container">
                <div class="game-sidebar">
                    <div class="stats-panel">
                        <h3>Statistics</h3>
                        <div class="stat-item">
                            <span>Money</span>
                            <span class="stat-value" id="moneyValue">$100</span>
                        </div>
                        <div class="stat-item">
                            <span>Depth</span>
                            <span class="stat-value" id="depthValue">0m</span>
                        </div>
                        <div class="stat-item">
                            <span>Gems Found</span>
                            <span class="stat-value" id="gemsFoundValue">0</span>
                        </div>
                        <div class="stat-item">
                            <span>Current Tool</span>
                            <span class="stat-value" id="currentToolValue">Basic Pickaxe</span>
                        </div>
                        <div class="stat-item">
                            <span>Mining Power</span>
                            <span class="stat-value" id="miningPowerValue">1</span>
                        </div>
                    </div>

                    <div class="tools-panel">
                        <h3>Tools</h3>
                        <button class="tool-option" data-type="pickaxe">
                            <span>Basic Pickaxe</span>
                            <span class="tool-cost">$0</span>
                        </button>
                        <button class="tool-option" data-type="upgrade">
                            <span>Upgrade Pickaxe</span>
                            <span class="tool-cost">$50</span>
                        </button>
                        <button class="tool-option" data-type="sell">
                            <span>Sell All Gems</span>
                            <span class="tool-cost">-</span>
                        </button>
                    </div>
                </div>

                <div class="main-area">
                    <canvas id="gameCanvas"></canvas>
                    <div class="game-controls">
                        <button class="control-btn" id="newGameBtn">New Game</button>
                        <button class="control-btn" id="resetMineBtn" style="display: none;">Reset Mine</button>
                    </div>
                    
                    <div class="inventory-panel">
                        <h3>Inventory</h3>
                        <div id="inventoryList">
                            <!-- Inventory items will be added here dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</article>

<div class="tooltip"></div>
<div class="notification"></div>
<div class="mining-particles"></div>

<style>
    /* Minimal custom styles needed for the game */
    #gameCanvas {
        background: #1a1a1a;
        border-radius: 8px;
        width: 300px;
        height: 300px;
        touch-action: none;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    .game-container {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .game-sidebar {
        background: #2d2d2d;
        border-radius: 10px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        overflow-y: auto;
        max-height: 700px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .stats-panel, .inventory-panel, .tools-panel {
        background: #363636;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .stats-panel h3, .inventory-panel h3, .tools-panel h3 {
        color: #ffffff;
        font-size: 18px;
        margin-top: 0;
        margin-bottom: 15px;
        font-weight: 600;
        border-bottom: 1px solid #4a4a4a;
        padding-bottom: 8px;
    }
    
    .inventory-panel {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .stat-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        font-size: 16px;
        color: #e0e0e0;
    }
    
    .stat-value {
        color: #4CAF50;
        font-weight: 600;
    }
    
    .inventory-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: #404040;
        border-radius: 4px;
        margin-bottom: 10px;
        transition: background 0.2s;
    }
    
    .inventory-item:hover {
        background: #4a4a4a;
    }
    
    .gem-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        margin-right: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .gem-name {
        flex-grow: 1;
        font-size: 16px;
        color: #e0e0e0;
    }
    
    .gem-count {
        color: #ffd700;
        font-weight: 600;
        font-size: 16px;
    }
    
    .gem-value {
        color: #4CAF50;
        margin-left: 10px;
        font-weight: 600;
        font-size: 16px;
    }
    
    .tool-option {
        background: #404040;
        border: none;
        border-radius: 6px;
        padding: 14px;
        color: white;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 12px;
        width: 100%;
        text-align: left;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 16px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .tool-option:hover {
        background: #4a4a4a;
        transform: translateY(-2px);
    }
    
    .tool-option.selected {
        background: #4CAF50;
        font-weight: 600;
    }
    
    .tool-cost {
        color: #ffd700;
        font-size: 16px;
        font-weight: 600;
    }
    
    .main-area {
        background: #2d2d2d;
        border-radius: 10px;
        padding: 20px;
        position: relative;
        overflow: hidden;
        height: auto;
        min-height: 400px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .game-controls {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-top: 15px;
        width: 100%;
    }
    
    .controls {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-bottom: 15px;
    }
    
    .control-btn {
        background: #4CAF50;
        border: none;
        border-radius: 6px;
        padding: 12px 24px;
        color: white;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
        font-size: 16px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .control-btn:hover {
        background: #45a049;
        transform: translateY(-2px);
    }
    
    .tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.9);
        padding: 12px;
        border-radius: 6px;
        font-size: 16px;
        pointer-events: none;
        z-index: 1000;
        display: none;
        color: #ffffff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        max-width: 250px;
        line-height: 1.4;
    }
    
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 12px 24px;
        border-radius: 6px;
        animation: slideIn 0.3s ease-out;
        display: none;
        z-index: 1000;
        font-size: 16px;
        font-weight: 600;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    .mining-particles {
        position: absolute;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 5;
    }
    
    .particle {
        position: absolute;
        background: #ffd700;
        border-radius: 50%;
        pointer-events: none;
        animation: particle-fade 1s forwards;
    }
    
    @keyframes particle-fade {
        0% {
            opacity: 1;
            transform: scale(1);
        }
        100% {
            opacity: 0;
            transform: scale(0);
        }
    }
    
    /* Game description styles */
    .game-description {
        background: #2d2d2d;
        border-radius: 8px;
        padding: 15px 20px;
        margin-bottom: 20px;
        color: #e0e0e0;
        font-size: 16px;
        line-height: 1.5;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .game-container {
            grid-template-columns: 1fr;
        }
        
        .game-sidebar {
            max-height: none;
        }
        
        .inventory-panel {
            max-height: 200px;
        }
    }
</style>

<script>
    class GemMiner {
        constructor() {
            this.canvas = document.getElementById('gameCanvas');
            this.ctx = this.canvas.getContext('2d');
            this.gridSize = 60; // Increased grid size for larger cells
            this.money = 100;
            this.depth = 0;
            this.maxDepth = 0; // Track the maximum depth reached
            this.gemsFound = 0;
            this.currentTool = 'pickaxe';
            this.miningPower = 1;
            this.toolLevel = {
                pickaxe: 1
            };
            this.tooltip = document.querySelector('.tooltip');
            this.notification = document.querySelector('.notification');
            this.particlesContainer = document.querySelector('.mining-particles');
            this.lastUpdateTime = Date.now();
            this.isMining = false;
            this.miningTarget = null;
            this.miningProgress = 0;
            this.scrollOffset = 0; // Track how much we've scrolled down
            this.visibleRows = 5; // Number of rows visible at once
            this.totalRows = 20; // Initial number of rows, will grow as needed
            this.generationBuffer = 5; // Number of rows to generate ahead of current depth
            
            // Define gem types
            this.gemTypes = {
                coal: {
                    name: 'Coal',
                    color: '#333333',
                    value: 5,
                    rarity: 0.6,
                    depth: 0,
                    icon: 'ü™®'
                },
                copper: {
                    name: 'Copper',
                    color: '#b87333',
                    value: 10,
                    rarity: 0.7,
                    depth: 0,
                    icon: 'üî∏'
                },
                iron: {
                    name: 'Iron',
                    color: '#a19d94',
                    value: 20,
                    rarity: 0.65,
                    depth: 2,
                    icon: 'üî∂'
                },
                silver: {
                    name: 'Silver',
                    color: '#c0c0c0',
                    value: 50,
                    rarity: 0.6,
                    depth: 4,
                    icon: '‚ö™'
                },
                gold: {
                    name: 'Gold',
                    color: '#ffd700',
                    value: 100,
                    rarity: 0.5,
                    depth: 6,
                    icon: 'üü°'
                },
                emerald: {
                    name: 'Emerald',
                    color: '#50c878',
                    value: 200,
                    rarity: 0.4,
                    depth: 8,
                    icon: 'üíö'
                },
                sapphire: {
                    name: 'Sapphire',
                    color: '#0f52ba',
                    value: 300,
                    rarity: 0.35,
                    depth: 10,
                    icon: 'üíô'
                },
                ruby: {
                    name: 'Ruby',
                    color: '#e0115f',
                    value: 400,
                    rarity: 0.3,
                    depth: 12,
                    icon: '‚ù§Ô∏è'
                },
                diamond: {
                    name: 'Diamond',
                    color: '#b9f2ff',
                    value: 1000,
                    rarity: 0.2,
                    depth: 14,
                    icon: 'üíé'
                }
            };
            
            // Define tool types
            this.toolTypes = {
                pickaxe: {
                    name: 'Pickaxe',
                    cost: 0,
                    color: '#a19d94',
                    miningSpeed: 1,
                    description: 'Used to mine rocks and gems'
                }
            };
            
            // Initialize inventory
            this.inventory = {};
            Object.keys(this.gemTypes).forEach(gemType => {
                this.inventory[gemType] = 0;
            });
            
            // Initialize mine grid with more rows than visible
            this.initializeMine();
            
            // Setup event listeners
            this.setupEventListeners();
            
            // Start game loop
            this.gameLoop();
            
            // Update UI
            this.updateUI();
        }
        
        initializeMine() {
            // Set canvas size - 5x10 grid
            this.canvas.width = 300; // 5 columns * 60px grid size
            this.canvas.height = 300; // 5 rows * 60px grid size
            
            // Initialize mine grid with more rows than visible
            this.mineGrid = [];
            for (let y = 0; y < this.totalRows; y++) {
                this.mineGrid[y] = [];
                for (let x = 0; x < 5; x++) { // Fixed 5 columns
                    // Determine what's in this cell based on depth
                    const cell = this.generateMineCell(x, y);
                    this.mineGrid[y][x] = cell;
                }
            }
            
            // Reset scroll offset
            this.scrollOffset = 0;
        }
        
        generateMineCell(x, y) {
            // Calculate depth based on y position (top is 0, bottom is deeper)
            const cellDepth = Math.floor(y / 2);
            
            // Determine if this cell is a gem or just dirt/rock
            const random = Math.random();
            let cellType = 'dirt';
            
            // First, determine if this cell will be a gem at all (30% chance)
            if (random < 0.3) {
                // Create an array of possible gems based on depth
                const possibleGems = [];
                
                // Add gems that are available at this depth
                for (const [gemType, gemData] of Object.entries(this.gemTypes)) {
                    // If we're at or past the required depth, add this gem to possible gems
                    if (cellDepth >= gemData.depth) {
                        possibleGems.push(gemType);
                    }
                }
                
                // If we have possible gems, randomly select one
                if (possibleGems.length > 0) {
                    const gemIndex = Math.floor(Math.random() * possibleGems.length);
                    cellType = possibleGems[gemIndex];
                }
            }
            
            return {
                type: cellType,
                mined: false,
                hardness: Math.random() * 10 + 1 // 1-10 hardness
            };
        }
        
        setupEventListeners() {
            // Tool selection
            const toolOptions = document.querySelectorAll('.tool-option');
            toolOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const type = option.getAttribute('data-type');
                    
                    if (type === 'upgrade') {
                        this.upgradeTool();
                    } else if (type === 'sell') {
                        this.sellAllGems();
                    } else {
                        // Select tool
                        toolOptions.forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                        this.currentTool = type;
                        this.updateUI();
                    }
                });
            });
            
            // Select default tool
            document.querySelector('.tool-option[data-type="pickaxe"]').classList.add('selected');
            
            // Track mouse position for tooltips
            this.lastMouseX = 0;
            this.lastMouseY = 0;
            this.canvas.addEventListener('mousemove', (e) => {
                const rect = this.canvas.getBoundingClientRect();
                this.lastMouseX = e.clientX - rect.left;
                this.lastMouseY = e.clientY - rect.top;
                
                // Show tooltip for mine cells
                const x = Math.floor(this.lastMouseX / this.gridSize);
                const y = Math.floor(this.lastMouseY / this.gridSize) + this.scrollOffset;
                
                if (x >= 0 && y >= 0 && x < this.mineGrid[0].length && y < this.mineGrid.length) {
                    const cell = this.mineGrid[y][x];
                    
                    if (!cell.mined) {
                        let tooltipText = '';
                        
                        if (cell.type === 'dirt') {
                            tooltipText = 'Dirt - Click to dig';
                        } else {
                            const gemData = this.gemTypes[cell.type];
                            tooltipText = `${gemData.name} - Value: $${gemData.value} - Click to mine`;
                        }
                        
                        this.showTooltip(
                            tooltipText,
                            '',
                            e.clientX,
                            e.clientY
                        );
                    } else {
                        this.hideTooltip();
                    }
                } else {
                    this.hideTooltip();
                }
            });
            
            // Canvas click for mining - prevent default to stop scrolling
            this.canvas.addEventListener('click', (e) => {
                // Prevent default behavior to stop scrolling
                e.preventDefault();
                e.stopPropagation();
                
                const rect = this.canvas.getBoundingClientRect();
                const x = Math.floor((e.clientX - rect.left) / this.gridSize);
                const y = Math.floor((e.clientY - rect.top) / this.gridSize) + this.scrollOffset;
                
                if (x >= 0 && y >= 0 && x < this.mineGrid[0].length && y < this.mineGrid.length) {
                    const cell = this.mineGrid[y][x];
                    
                    if (!cell.mined) {
                        this.startMining(x, y);
                    }
                }
                
                return false;
            });
            
            // Add touch event handling for mobile devices
            this.canvas.addEventListener('touchstart', (e) => {
                // Prevent default behavior to stop scrolling
                e.preventDefault();
                e.stopPropagation();
                
                const rect = this.canvas.getBoundingClientRect();
                const touch = e.touches[0];
                const x = Math.floor((touch.clientX - rect.left) / this.gridSize);
                const y = Math.floor((touch.clientY - rect.top) / this.gridSize) + this.scrollOffset;
                
                if (x >= 0 && y >= 0 && x < this.mineGrid[0].length && y < this.mineGrid.length) {
                    const cell = this.mineGrid[y][x];
                    
                    if (!cell.mined) {
                        this.startMining(x, y);
                    }
                }
                
                return false;
            }, { passive: false });
            
            // Prevent scrolling on the entire document
            document.addEventListener('touchmove', (e) => {
                if (e.target === this.canvas || this.canvas.contains(e.target)) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // New game button
            document.getElementById('newGameBtn').addEventListener('click', () => {
                this.resetGame();
            });
            
            // Reset mine button
            document.getElementById('resetMineBtn').addEventListener('click', () => {
                this.resetMine();
            });
            
            // Window resize
            window.addEventListener('resize', () => {
                this.initializeMine();
            });
        }
        
        showTooltip(title, description, x, y) {
            this.tooltip.style.display = 'block';
            this.tooltip.style.left = `${x + 10}px`;
            this.tooltip.style.top = `${y + 10}px`;
            this.tooltip.innerHTML = `
                <strong>${title}</strong><br>
                ${description}
            `;
        }
        
        hideTooltip() {
            this.tooltip.style.display = 'none';
        }
        
        showNotification(message) {
            this.notification.textContent = message;
            this.notification.style.display = 'block';
            setTimeout(() => {
                this.notification.style.display = 'none';
            }, 3000);
        }
        
        startMining(x, y) {
            this.isMining = true;
            this.miningTarget = { x, y };
            this.miningProgress = 0;
            
            // Calculate mining time based on cell hardness and tool
            const cell = this.mineGrid[y][x];
            const toolData = this.toolTypes[this.currentTool];
            const miningTime = (cell.hardness / (toolData.miningSpeed * this.toolLevel[this.currentTool])) * 1000;
            
            // Create mining animation
            this.createMiningAnimation(x, y);
            
            // Complete mining immediately instead of using interval
            this.completeMining(x, y);
        }
        
        stopMining() {
            this.isMining = false;
            this.miningTarget = null;
            this.miningProgress = 0;
            
            if (this.miningInterval) {
                clearInterval(this.miningInterval);
            }
        }
        
        completeMining(x, y) {
            const cell = this.mineGrid[y][x];
            cell.mined = true;
            
            // If it's a gem, add to inventory
            if (cell.type !== 'dirt') {
                this.inventory[cell.type]++;
                this.gemsFound++;
                
                // Create particle effect
                this.createParticleEffect(x, y, this.gemTypes[cell.type].color);
                
                // Show notification
                this.showNotification(`Found ${this.gemTypes[cell.type].name}!`);
            }
            
            // Update depth if we've gone deeper
            const cellDepth = Math.floor(y / 2);
            if (cellDepth > this.maxDepth) {
                this.maxDepth = cellDepth;
                this.depth = this.maxDepth; // Update current depth
                this.showNotification(`Reached depth ${this.depth}m!`);
            }
            
            // Check if we need to scroll down
            this.checkForScroll(y);
            
            // Check if all blocks are mined
            this.checkAllBlocksMined();
            
            // Update UI
            this.updateUI();
        }
        
        checkForScroll(y) {
            // Check if the current row is cleared
            let currentRowCleared = true;
            const currentRow = this.scrollOffset;
            
            // Check if all blocks in the current row are mined
            for (let checkX = 0; checkX < this.mineGrid[currentRow].length; checkX++) {
                if (!this.mineGrid[currentRow][checkX].mined) {
                    currentRowCleared = false;
                    break;
                }
            }
            
            // If the current row is cleared, scroll down
            if (currentRowCleared) {
                this.scrollOffset++;
                this.showNotification(`Row cleared! Digging deeper to ${this.scrollOffset}m`);
                
                // Check if we need to generate more rows
                this.ensureMineDepth();
            }
        }
        
        // New method to ensure the mine has enough rows
        ensureMineDepth() {
            // Calculate the current depth we're at
            const currentDepth = this.scrollOffset + this.visibleRows;
            
            // If we're close to the end of our generated rows, add more
            if (currentDepth + this.generationBuffer >= this.mineGrid.length) {
                // Add more rows to the mine
                const rowsToAdd = 10; // Add 10 rows at a time
                const startRow = this.mineGrid.length;
                
                // Create a temporary array to store the new rows
                const newRows = [];
                
                for (let y = startRow; y < startRow + rowsToAdd; y++) {
                    newRows[y] = [];
                    for (let x = 0; x < 5; x++) {
                        // Generate a new cell with proper depth calculation
                        const cell = this.generateMineCell(x, y);
                        newRows[y][x] = cell;
                    }
                }
                
                // Add the new rows to the mine grid
                for (let y = startRow; y < startRow + rowsToAdd; y++) {
                    this.mineGrid[y] = newRows[y];
                }
                
                // Update total rows
                this.totalRows = this.mineGrid.length;
                
                // Show notification about the mine getting deeper
                this.showNotification(`The mine extends deeper!`);
            }
        }
        
        checkAllBlocksMined() {
            // For a bottomless mine, we don't need to check if all blocks are mined
            // Instead, we'll just check if the current visible area is mined
            let visibleAreaMined = true;
            
            for (let y = this.scrollOffset; y < Math.min(this.scrollOffset + this.visibleRows, this.mineGrid.length); y++) {
                for (let x = 0; x < this.mineGrid[y].length; x++) {
                    if (!this.mineGrid[y][x].mined) {
                        visibleAreaMined = false;
                        break;
                    }
                }
                if (!visibleAreaMined) break;
            }
            
            // Show reset mine button if all visible blocks are mined
            const resetMineBtn = document.getElementById('resetMineBtn');
            if (visibleAreaMined) {
                resetMineBtn.style.display = 'block';
                this.showNotification('Current area cleared! Click "Reset Mine" to generate a new mine.');
            } else {
                resetMineBtn.style.display = 'none';
            }
        }
        
        resetMine() {
            // Reinitialize mine grid without resetting inventory or money
            this.initializeMine();
            
            // Reset depth but keep max depth
            this.depth = 0;
            
            // Hide reset mine button
            document.getElementById('resetMineBtn').style.display = 'none';
            
            // Show notification
            this.showNotification('Mine reset! New gems are available.');
        }
        
        createMiningAnimation(x, y) {
            // Create mining particles
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    this.createParticleEffect(x, y, '#8b4513');
                }, i * 200);
            }
        }
        
        createParticleEffect(x, y, color) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.backgroundColor = color;
            particle.style.width = `${Math.random() * 5 + 3}px`;
            particle.style.height = particle.style.width;
            
            // Position at the center of the cell
            const centerX = x * this.gridSize + this.gridSize / 2;
            const centerY = y * this.gridSize + this.gridSize / 2;
            
            particle.style.left = `${centerX}px`;
            particle.style.top = `${centerY}px`;
            
            // Random direction
            const angle = Math.random() * Math.PI * 2;
            const distance = Math.random() * 30 + 10;
            const targetX = centerX + Math.cos(angle) * distance;
            const targetY = centerY + Math.sin(angle) * distance;
            
            // Add to container
            this.particlesContainer.appendChild(particle);
            
            // Animate
            particle.animate([
                { left: `${centerX}px`, top: `${centerY}px`, opacity: 1 },
                { left: `${targetX}px`, top: `${targetY}px`, opacity: 0 }
            ], {
                duration: 1000,
                easing: 'ease-out'
            }).onfinish = () => {
                particle.remove();
            };
        }
        
        upgradeTool() {
            const toolData = this.toolTypes[this.currentTool];
            const upgradeCost = 50 * this.toolLevel[this.currentTool];
            
            if (this.money >= upgradeCost) {
                this.money -= upgradeCost;
                this.toolLevel[this.currentTool]++;
                this.miningPower = this.toolLevel[this.currentTool];
                
                this.updateUI();
                this.showNotification(`Upgraded ${toolData.name} to level ${this.toolLevel[this.currentTool]}!`);
            } else {
                this.showNotification('Not enough money to upgrade!');
            }
        }
        
        sellAllGems() {
            let totalValue = 0;
            
            for (const [gemType, count] of Object.entries(this.inventory)) {
                if (count > 0) {
                    const gemData = this.gemTypes[gemType];
                    const value = gemData.value * count;
                    totalValue += value;
                    
                    // Reset inventory count
                    this.inventory[gemType] = 0;
                }
            }
            
            if (totalValue > 0) {
                this.money += totalValue;
                this.updateUI();
                this.showNotification(`Sold all gems for $${totalValue}!`);
            } else {
                this.showNotification('No gems to sell!');
            }
        }
        
        resetGame() {
            this.money = 100;
            this.depth = 0;
            this.gemsFound = 0;
            this.currentTool = 'pickaxe';
            this.miningPower = 1;
            this.toolLevel = {
                pickaxe: 1
            };
            
            // Reset inventory
            Object.keys(this.inventory).forEach(gemType => {
                this.inventory[gemType] = 0;
            });
            
            // Reinitialize mine
            this.initializeMine();
            
            // Reset UI
            document.querySelectorAll('.tool-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector('.tool-option[data-type="pickaxe"]').classList.add('selected');
            
            this.updateUI();
            this.showNotification('New game started!');
        }
        
        updateUI() {
            // Update stats
            document.getElementById('moneyValue').textContent = `$${this.money.toLocaleString()}`;
            document.getElementById('depthValue').textContent = `${this.depth}m`;
            document.getElementById('gemsFoundValue').textContent = this.gemsFound;
            
            // Update current tool
            const toolData = this.toolTypes[this.currentTool];
            document.getElementById('currentToolValue').textContent = `${toolData.name} (Level ${this.toolLevel[this.currentTool]})`;
            document.getElementById('miningPowerValue').textContent = this.miningPower;
            
            // Update inventory
            const inventoryList = document.getElementById('inventoryList');
            inventoryList.innerHTML = '';
            
            for (const [gemType, count] of Object.entries(this.inventory)) {
                if (count > 0) {
                    const gemData = this.gemTypes[gemType];
                    const inventoryItem = document.createElement('div');
                    inventoryItem.className = 'inventory-item';
                    inventoryItem.innerHTML = `
                        <span class="gem-icon" style="background-color: ${gemData.color};">${gemData.icon}</span>
                        <span class="gem-name">${gemData.name}</span>
                        <span class="gem-count">${count}</span>
                        <span class="gem-value">$${gemData.value * count}</span>
                    `;
                    inventoryList.appendChild(inventoryItem);
                }
            }
            
            // Update tool costs
            document.querySelector('.tool-option[data-type="upgrade"] .tool-cost').textContent = 
                `$${50 * this.toolLevel[this.currentTool]}`;
        }
        
        updateGame() {
            const currentTime = Date.now();
            const deltaTime = currentTime - this.lastUpdateTime;
            this.lastUpdateTime = currentTime;
            
            // Check if we need to generate more rows
            this.ensureMineDepth();
        }
        
        draw() {
            // Clear canvas
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            
            // Draw mine grid with scroll offset
            for (let y = this.scrollOffset; y < Math.min(this.scrollOffset + this.visibleRows, this.mineGrid.length); y++) {
                for (let x = 0; x < this.mineGrid[y].length; x++) {
                    const cell = this.mineGrid[y][x];
                    const displayY = y - this.scrollOffset; // Adjust y position for display
                    
                    if (!cell.mined) {
                        // Draw cell background
                        if (cell.type === 'dirt') {
                            this.ctx.fillStyle = '#8b4513'; // Brown for dirt
                        } else {
                            const gemData = this.gemTypes[cell.type];
                            this.ctx.fillStyle = gemData.color;
                        }
                        
                        this.ctx.fillRect(
                            x * this.gridSize, 
                            displayY * this.gridSize, 
                            this.gridSize, 
                            this.gridSize
                        );
                        
                        // Draw cell border
                        this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
                        this.ctx.lineWidth = 1;
                        this.ctx.strokeRect(
                            x * this.gridSize, 
                            displayY * this.gridSize, 
                            this.gridSize, 
                            this.gridSize
                        );
                        
                        // Draw gem icon if it's a gem
                        if (cell.type !== 'dirt') {
                            const gemData = this.gemTypes[cell.type];
                            this.ctx.fillStyle = 'white';
                            this.ctx.font = '20px Arial';
                            this.ctx.textAlign = 'center';
                            this.ctx.textBaseline = 'middle';
                            this.ctx.fillText(
                                gemData.icon,
                                x * this.gridSize + this.gridSize / 2,
                                displayY * this.gridSize + this.gridSize / 2
                            );
                        }
                    } else {
                        // Draw mined cell (empty)
                        this.ctx.fillStyle = '#2d2d2d';
                        this.ctx.fillRect(
                            x * this.gridSize, 
                            displayY * this.gridSize, 
                            this.gridSize, 
                            this.gridSize
                        );
                        
                        // Draw cell border
                        this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                        this.ctx.lineWidth = 1;
                        this.ctx.strokeRect(
                            x * this.gridSize, 
                            displayY * this.gridSize, 
                            this.gridSize, 
                            this.gridSize
                        );
                    }
                }
            }
            
            // Draw depth indicator
            this.ctx.fillStyle = 'white';
            this.ctx.font = '12px Roboto';
            this.ctx.textAlign = 'left';
            this.ctx.textBaseline = 'top';
            this.ctx.fillText(`Depth: ${this.depth}m`, 10, 10);
            
            // Draw depth markers on the right side
            this.drawDepthMarkers();
        }
        
        drawDepthMarkers() {
            const markerWidth = 20;
            const markerSpacing = 50; // One marker every 5m (50px)
            
            this.ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            this.ctx.font = '10px Roboto';
            this.ctx.textAlign = 'right';
            
            // Draw markers every 5m, adjusted for scroll offset
            for (let y = 0; y < this.canvas.height; y += markerSpacing) {
                const depth = Math.floor((y + this.scrollOffset * this.gridSize) / 2);
                
                // Draw marker line
                this.ctx.fillRect(
                    this.canvas.width - markerWidth, 
                    y, 
                    markerWidth, 
                    1
                );
                
                // Draw depth text
                this.ctx.fillText(
                    `${depth}m`, 
                    this.canvas.width - markerWidth - 5, 
                    y - 5
                );
            }
        }
        
        gameLoop() {
            this.updateGame();
            this.draw();
            requestAnimationFrame(() => this.gameLoop());
        }
    }

    let game;

    function newGame() {
        game = new GemMiner();
    }

    // Start the game when the page loads
    window.onload = newGame;
</script>
{% endblock %} 